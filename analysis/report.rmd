---
params: 
  set_title:
    label: "report title"
    value: "Project"
    input: text
  set_author: 
    label: "author"
    value: "Miles Smith"
    input: text
title: "`r params$set_title`"
author: "`r params$set_author`"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    highlight: "pygments"
    toc: TRUE
    toc_depth: 3
    toc_float: TRUE
  pdf_document:
    highlight: "pygments"
    toc: TRUE
    toc_depth: 3
always_allow_html: true
---

```{css, echo=FALSE}
    body .main-container {
      max-width: 1500px !important;
      width: 1500px !important;
    }
    body {
      max-width: 1500px !important;
    }
    caption {
      color: black;
      font-weight: bold;
      font-size: 1.0em;
    }
```

```{r setup, include=FALSE}
options(width = 1200)
knitr::opts_chunk$set(echo = FALSE, root.dir = here(), warning=FALSE, message=FALSE)
theme_set(theme_pubr())
```

```{r}
loadd(dds_with_scores, res)
```

```{r disease_class_table}
md <- colData(dds_with_scores) %>% as_tibble(rownames = "sample_name")
md %>%
  tabyl(disease_class) %>%
  rename(`Disease classification` = disease_class,
         Number = n,
         Percent = percent) %>%
  qflextable() %>%
  set_formatter(
    Percent = function(x) sprintf("%.01f", x*100)
  ) %>%
  set_table_properties(layout = "autofit")
```

\newpage

# Differential Gene Expression {.tabset .tabset-fade .tabset-pills}
```{r DE_table, echo=FALSE, paged.print=TRUE}
res %>% 
  map(alt_summary) %>%
  enframe() %>%
  unnest(cols = c(value)) %>%
  mutate(
    `up %` = round(100*(as.integer(up)/as.integer(total)),
                   digits = 2),
    `down %` = round(100*(as.integer(down)/as.integer(total)),
                     digits = 2),
    `low counts %` = round(100*(as.integer(lowcounts)/as.integer(total)),
                           digits = 2),
    name = str_replace_all(string = name, 
                           pattern = "_",
                           replacement = " ")
    ) %>%
  select(
    Comparison = name,
    `# Up\nregulated` = up,
    `% Up\nregulated` = `up %`,
    `# Down\nregulated` = down,
    `% Down\nregulated` = `down %`,
    `Mean count\ncutoff` = ft,
    `# Low\ncounts` = lowcounts,
    `% Low\ncounts` = `low counts %`
    ) %>%
  qflextable() %>%
  set_formatter(
    `% Up\nregulated` = function(x) sprintf("%.02f", x),
    `% Down\nregulated` = function(x) sprintf("%.02f", x),
    `% Low\ncounts` = function(x) sprintf("%.02f", x)
  ) %>%
  bold(part = "header") %>%
  # align(align = "center", part = "header", j = 2:8) %>%
  align(align = "left", part = "body", j = 1) %>%
  set_table_properties(layout = "autofit")
```

\newpage

## 25 genes with largest negative log-fold change in experimental group {.tabset .tabset-fade .tabset-pills}
```{r 25_top_down_DE, echo = FALSE}
loadd(down_tables)
```

```{r 25_top_down_DE_tbl, echo=FALSE, results='asis'}
for (i in seq_along(down_tables)){
  dtbl <-down_tables[[i]] %>%
    dplyr::select(-baseMean) %>%
    dplyr::filter(log2FoldChange > 0) %>%
    arrange(desc(log2FoldChange)) %>%
    ungroup() %>%
    rename(
      Gene = gene,
      `Log-fold change\nstandard error` = lfcSE,
      `P-value` = pvalue,
      `Adjusted\nP-value` = padj) %>%
    qflextable() %>%
      flextable::footnote(
        i = 1,
        j = 4:5,
        part = "header",
        value = 
          as_paragraph(
            c("Wald test p-values",
              "Benjamini–Hochberg adjusted value"
              )
            ),
        ref_symbols = c("*","†")
        ) %>%
    bold(part = "header") %>%
    set_formatter(
      log2FoldChange = function(x) sprintf("%.02g", x)
    ) %>%
    flextable::compose(
      i = 1,
      j = 2,
      part = "header",
      value = as_paragraph(
        "Log",
        as_sub("2"),
        "-fold change"
        )
      ) %>%
    add_header_lines(values = names(down_tables)[[i]]) %>%
    set_table_properties(layout = "autofit")

  cat(knit_print(dtbl))
}
```

## 25 genes with largest positive log-fold change in experimental group {.tabset .tabset-fade .tabset-pills}
```{r 25_top_up_DE, echo = FALSE}
loadd(up_tables)
```

```{r 25_top_up_DE_tbl, echo = FALSE, results='asis'}
for (j in seq_along(up_tables)){
  utbl <- up_tables[[j]] %>%
    select(-baseMean) %>%
    filter(log2FoldChange > 0) %>%
    arrange(desc(log2FoldChange)) %>%
    ungroup() %>%
    rename(
      Gene = gene,
      `Log-fold change\nstandard error` = lfcSE,
      `P-value` = pvalue,
      `Adjusted\nP-value` = padj) %>%
    qflextable() %>%
      flextable::footnote(
        i = 1,
        j = 4:5,
        part = "header",
        value = 
          as_paragraph(
            c("Wald test p-values",
              "Benjamini–Hochberg adjusted value"
              )
            ),
        ref_symbols = c("*","†")
        ) %>%
    bold(part = "header") %>%
    set_formatter(
      log2FoldChange = function(x) sprintf("%.02g", x)
    ) %>%
    flextable::compose(
      i = 1,
      j = 2,
      part = "header",
      value = as_paragraph(
        "Log",
        as_sub("2"),
        "-fold change"
        )
      ) %>%
    add_header_lines(values = names(up_tables)[[j]]) %>%
    set_table_properties(layout = "autofit")

  cat(knit_print(utbl))
  }
```

\newpage

## Expression of top class DE genes by class {.tabset .tabset-fade .tabset-pills}

```{r}
loadd(deg_class, final_md, vsd_exprs, annotation_info, group_pal, up_tables, down_tables)
```

### Sorted by disease classification
```{r top_class_DE_disease_sort, fig.width=12, fig.height=9}

deg_class_tbl <-
  as_tibble(
    deg_class,
    rownames = "gene"
    )

comparisons = unique(deg_class_tbl$comparison)

final_md_tbl <-
  final_md %>%
  as_tibble(rownames = "subject") %>%
  filter(subject %in% colnames(vsd_exprs))

range_bound = 4
zscore_range <- c(-range_bound:range_bound)
comparison_names <- union(names(up_tables), names(down_tables))

for (i in comparison_names){
  #comparison_genes <- filter(deg_class_tbl, comparison == i) %>% pull(gene)
  comparison_genes <- pull(bind_rows(up_tables[[i]], down_tables[[i]]), gene)
  
  people <-
    filter(
      .data = final_md_tbl,
      disease_class %in% str_split(i, "_vs_", simplify = TRUE)) %>%
    pull(subject)
  
  matrix_to_plot <- t(vsd_exprs)[people,comparison_genes]
  
  sample_disease_order_info <-
    annotation_info %>%
    as_tibble(rownames = "subject") %>%
    filter(subject %in% people) %>%
    arrange(disease_class)
  
  sample_disease_order <-
    sample_disease_order_info %>%
    pull(subject)
  
  sample_disease_order_count <-
    sample_disease_order_info %>%
    dplyr::count(disease_class) %>%
    pull(n) %>%
    accumulate(sum)
    
  matrix_to_plot[
    sample_disease_order,
    colVars(matrix_to_plot) > 1e-10
    ] %>% 
      pheatmap(
        scale = 'column',
        main = i,
        fontsize = 9,
        fontsize_col = 9,
        cluster_rows = FALSE,
        show_rownames = FALSE,
        annotation_row = annotation_info,
        annotation_colors = group_pal,
        angle_col = 315,
        breaks = zscore_range,
        color = viridis(n = length(zscore_range), option = "D"),
        border_color = NA,
        gaps_row = sample_disease_order_count
      )
  }
```

### Sorted by cluster
```{r top_class_DE_cluster_sort, fig.width=12, fig.height=9}

deg_class_tbl <- as_tibble(deg_class, rownames = "gene")
comparisons = unique(deg_class_tbl$comparison)

final_md_tbl <- final_md %>% as_tibble(rownames = "subject") %>% filter(subject %in% colnames(vsd_exprs))

range_bound = 4
zscore_range <- c(-range_bound:range_bound)
comparison_names <- union(names(up_tables), names(down_tables))

for (i in comparison_names){
  #comparison_genes <- filter(deg_class_tbl, comparison == i) %>% pull(gene)
  comparison_genes <- pull(bind_rows(up_tables[[i]], down_tables[[i]]), gene)
  
  people <-
    filter(
      .data = final_md_tbl,
      disease_class %in% str_split(i, "_vs_", simplify = TRUE)) %>%
    pull(subject)
  
  matrix_to_plot <- t(vsd_exprs)[people,comparison_genes]
  
  sample_cluster_order_info <-
    annotation_info %>%
    as_tibble(rownames = "subject") %>%
    filter(subject %in% people) %>%
    arrange(cluster)
  
  sample_cluster_order <-
    sample_cluster_order_info %>%
    pull(subject)
  
  sample_cluster_order_count <-
    sample_cluster_order_info %>%
    dplyr::count(cluster) %>%
    pull(n) %>%
    accumulate(sum)
  
  matrix_to_plot[
    sample_cluster_order,
    colVars(matrix_to_plot) > 1e-10
    ] %>% 
      pheatmap(
        scale = 'column',
        main = i,
        fontsize = 9,
        fontsize_col = 9,
        cluster_rows = FALSE,
        show_rownames = FALSE,
        annotation_row = annotation_info,
        annotation_colors = group_pal,
        angle_col = 315,
        breaks = zscore_range,
        color = viridis(n = length(zscore_range), option = "D"),
        border_color = NA,
        gaps_row = sample_cluster_order_count
      )
  }
```

### Sorted by hierarchical clustering
```{r top_class_DE_hierarchical_sort, fig.width=12, fig.height=9}
deg_class_tbl <- as_tibble(deg_class, rownames = "gene")
comparisons = unique(deg_class_tbl$comparison)

final_md_tbl <- final_md %>% as_tibble(rownames = "subject") %>% filter(subject %in% colnames(vsd_exprs))

range_bound = 4
zscore_range <- c(-range_bound:range_bound)
comparison_names <- union(names(up_tables), names(down_tables))

for (i in comparison_names){
  #comparison_genes <- filter(deg_class_tbl, comparison == i) %>% pull(gene)
  comparison_genes <- pull(bind_rows(up_tables[[i]], down_tables[[i]]), gene)
  
  people <-
    filter(
      .data = final_md_tbl,
      disease_class %in% str_split(i, "_vs_", simplify = TRUE)) %>%
    pull(subject)
  
  matrix_to_plot <- t(vsd_exprs)[people,comparison_genes]
  
  matrix_to_plot[,
    colVars(matrix_to_plot) > 1e-10
    ] %>% 
      pheatmap(
        scale = 'column',
        main = i,
        fontsize = 9,
        fontsize_col = 9,
        cluster_rows = TRUE,
        show_rownames = FALSE,
        annotation_row = annotation_info,
        annotation_colors = group_pal,
        angle_col = 315,
        breaks = zscore_range,
        color = viridis(n = length(zscore_range), option = "D"),
        border_color = NA
      )
  }
```

\newpage

## Expression of all top DE genes {.tabset .tabset-fade .tabset-pills}
```{r}
loadd(deg_means)
```

```{r Expression_of_all_top_DE_genes, fig.width=12, fig.height=9}

#### sort by disease ####
sample_disease_order_info <-
  annotation_info %>%
  as_tibble(rownames = "subject") %>%
  arrange(disease_class)

sample_disease_order <-
  sample_disease_order_info %>%
  pull(subject)
  
sample_disease_order_count <-
  sample_disease_order_info %>%
  dplyr::count(disease_class) %>%
  pull(n) %>%
  accumulate(sum)

#### sort by cluster ####
sample_cluster_order_info <-
  annotation_info %>%
  as_tibble(rownames = "subject") %>%
  arrange(cluster)

sample_cluster_order <-
  sample_cluster_order_info %>%
  pull(subject)
  
sample_cluster_order_count <-
  sample_cluster_order_info %>%
  dplyr::count(cluster) %>%
  pull(n) %>%
  accumulate(sum)

range_bound = 4
zscore_range <- c(-range_bound:range_bound)
```

### Sorted by disease classification
```{r Expression_of_all_top_DE_genes_disease_sort, fig.width=12, fig.height=9}
t(vsd_exprs)[sample_disease_order,colnames(deg_means)] %>% 
    pheatmap(
      scale = 'column',
      fontsize = 9,
      fontsize_col = 6,
      show_rownames = FALSE,
      annotation_row = annotation_info,
      annotation_colors = group_pal,
      angle_col = 315,
      breaks = zscore_range,
      cluster_rows = FALSE,
      color = viridis(n = length(zscore_range)-1, option = "D"),
      gaps_row = sample_disease_order_count,
      border_color = NA
      )
```

### Sorted by cluster
```{r Expression_of_all_top_DE_genes_cluster_sort, fig.width=12, fig.height=9}
sample_cluster_order <-
  annotation_info %>%
  as_tibble(rownames = "subject") %>%
  arrange(cluster) %>%
  pull(subject)
  
range_bound = 4
zscore_range <- c(-range_bound:range_bound)
t(vsd_exprs)[sample_cluster_order,colnames(deg_means)] %>% 
    pheatmap(
      scale = 'column',
      fontsize = 9,
      fontsize_col = 6,
      show_rownames = FALSE,
      annotation_row = annotation_info,
      annotation_colors = group_pal,
      angle_col = 315,
      breaks = zscore_range,
      cluster_rows = FALSE,
      color = viridis(n = length(zscore_range)-1, option = "D"),
      gaps_row = sample_cluster_order_count,
      border_color = NA
      )
```

### Sorted by hierarchical clustering
```{r Expression_of_all_top_DE_genes_auto_sort, fig.width=12, fig.height=9}
range_bound = 4
zscore_range <- c(-range_bound:range_bound)
t(vsd_exprs)[,colnames(deg_means)] %>% 
    pheatmap(
      scale = 'column',
      fontsize = 9,
      fontsize_col = 6,
      show_rownames = FALSE,
      annotation_row = annotation_info,
      annotation_colors = group_pal,
      angle_col = 315,
      breaks = zscore_range,
      cluster_rows = TRUE,
      color = viridis(n = length(zscore_range)-1, option = "D"),
      gaps_col = class_gaps,
      border_color = NA
      )
```

\newpage

## Volcano plot of gene expression
```{r Volcano_plot_of_gene_expression, fig.height=6, fig.width=9}

inverse_format <- function() {
  function(x) format(-x,) 
}

for(k in seq_along(res)){

    volcano_data <- 
      res[[k]] %>%
      as_tibble(rownames = "gene") %>%
      mutate(sig = case_when(
        padj > 0.01 ~ "insig",
        padj < 0.01 & log2FoldChange <= -0.25 ~ "down",
        padj < 0.01 & log2FoldChange >= 0.25 ~ "up",
        padj < 0.01 & between(log2FoldChange, -1, 1) ~ "ignore",
        is.na(padj) ~ "insig")
      )

    volcano_data_up =
      top_n(
        x = filter(
          .data = volcano_data,
          sig == "up"
          ),
        n = 20, 
        wt = log2FoldChange
        ) %>%
      mutate(
        sig = sig %>%
          as_factor() %>%
          fct_recode(
            "Up-regulated" = "up"
            )
        )
    volcano_data_down = 
        top_n(
        x = filter(
          .data = volcano_data,
          sig == "down"
          ),
        n = -20,
        wt = log2FoldChange
        ) %>%
      mutate(
        sig = sig %>%
          as_factor() %>%
          fct_recode(
            "Down-regulated" = "down"
            )
        )

  vp <-
    volcano_data %>%
      mutate(
        sig = sig %>%
          as_factor() %>%
          fct_recode(
            "p > 0.05" = "insig",
            "Up-regulated" = "up",
            "Down-regulated" = "down"
            )
        ) %>%
      filter(sig != "ignore") %>%
      ggplot(
        aes(
          x = log2FoldChange,
          y = (1/padj),
          color = sig
        ),
        alpha = 0.25
      ) +
      geom_point() +
      geom_text_repel(
        data = volcano_data_up,
        aes(
          x = log2FoldChange,
          y = 1/padj,
          label = gene
          ),
        show.legend = FALSE
      ) +
      geom_text_repel(
        data = volcano_data_down,
        aes(
          x = log2FoldChange,
          y = 1/padj,
          label = gene
        ),
        show.legend = FALSE
      ) +
      scale_y_log10(
        labels = inverse_format()
      ) +
      scale_color_manual(values = c('grey',"blue",'red')) +
      labs(x = "Log 2 fold change",
           y = "Adjusted p-value",
           title = names(res)[[k]])

  print(vp)
}
```

\newpage

## Expression of selected interferon-stimulated genes {.tabset .tabset-fade .tabset-pills}
```{r Expression_of_selected_interferon-stimulated genes, fig.height=6, fig.width=9}
loadd(ISGs)
```

### Sorted by disease classification
```{r Expression_of_ISGs_disease_sort, fig.width=12, fig.height=9}
range_bound = 4
zscore_range <- c(-range_bound:range_bound)
t(vsd_exprs)[sample_disease_order,ISGs] %>%
    pheatmap(
      scale = 'column',
      fontsize = 8,
      show_rownames = FALSE,
      annotation_row = annotation_info,
      annotation_colors = group_pal,
      angle_col = 315,
      breaks = zscore_range,
      cluster_rows = FALSE,
      color = viridis(n = length(zscore_range)-1, option = "D"),
      gaps_row = sample_disease_order_count,
      border_color = NA)
```


### Sorted by cluster
```{r Expression_of_ISGs_cluster_sort, fig.width=12, fig.height=9}
range_bound = 4
zscore_range <- c(-range_bound:range_bound)
t(vsd_exprs)[sample_cluster_order,ISGs] %>%
    pheatmap(
      scale = 'column',
      fontsize = 8,
      show_rownames = FALSE,
      annotation_row = annotation_info,
      annotation_colors = group_pal,
      angle_col = 315,
      breaks = zscore_range,
      cluster_rows = FALSE,
      color = viridis(n = length(zscore_range)-1, option = "D"),
      gaps_col = class_gaps,
      gaps_row = sample_cluster_order_count,
      border_color = NA)
```

### Sorted by hierarchical clustering
```{r Expression_of_ISGs_auto_sort, fig.width=12, fig.height=9}
range_bound = 4
zscore_range <- c(-range_bound:range_bound)
t(vsd_exprs)[,ISGs] %>%
    pheatmap(
      scale = 'column',
      fontsize = 8,
      show_rownames = FALSE,
      annotation_row = annotation_info,
      annotation_colors = group_pal,
      angle_col = 315,
      breaks = zscore_range,
      color = viridis(n = length(zscore_range)-1, option = "D"),
      cluster_rows = TRUE,
      gaps_col = class_gaps,
      border_color = NA)
```

\newpage

## Expression of individual genes in the M1.2, M3.4, and M5.12 gene modules {.tabset .tabset-fade .tabset-pills}
```{r Expression_of_individual_genes_in_the_M1.2, M3.4, and M5.12 gene modules, fig.height=6, fig.width=9}
loadd(module_ISGs)
```

### Sorted by disease classification
```{r module_ISGs_disease_sort, fig.width=12, fig.height=9}
range_bound = 4
zscore_range <- c(-range_bound:range_bound)
t(vsd_exprs)[sample_disease_order,(arrange(as_tibble(module_ISGs, rownames = "gene"), module)$gene)] %>%
  pheatmap(
    scale = 'column',
    fontsize = 6,
    show_rownames = FALSE,
    annotation_row = annotation_info,
    annotation_col = module_ISGs,
    annotation_colors = group_pal,
    cluster_cols = FALSE,
    cluster_rows = FALSE,
    angle_col = 315,
    breaks = zscore_range,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    gaps_row = sample_disease_order_count,
    border_color = NA)
```

### Sorted by cluster
```{r module_ISGs_cluster_sort, fig.width=12, fig.height=9}
range_bound = 4
zscore_range <- c(-range_bound:range_bound)
t(vsd_exprs)[sample_cluster_order,(arrange(as_tibble(module_ISGs, rownames = "gene"), module)$gene)] %>%
  pheatmap(
    scale = 'column',
    fontsize = 6,
    show_rownames = FALSE,
    annotation_row = annotation_info,
    annotation_col = module_ISGs,
    annotation_colors = group_pal,
    cluster_cols = FALSE,
    cluster_rows = FALSE,
    angle_col = 315,
    breaks = zscore_range,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    gaps_row = sample_cluster_order_count,
    border_color = NA)
```

### Sorted by hierarchical clustering
```{r module_ISGs_auto_sort, fig.width=12, fig.height=9}
range_bound = 4
zscore_range <- c(-range_bound:range_bound)
t(vsd_exprs)[sample_disease_order,(arrange(as_tibble(module_ISGs, rownames = "gene"), module)$gene)] %>%
  pheatmap(
    scale = 'column',
    fontsize = 6,
    show_rownames = FALSE,
    annotation_row = annotation_info,
    annotation_col = module_ISGs,
    annotation_colors = group_pal,
    cluster_cols = FALSE,
    cluster_rows = TRUE,
    angle_col = 315,
    breaks = zscore_range,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    border_color = NA
    )
```

\newpage

# Sample Clustering

The eigenvales for the annotated Banchereau modules were used to calculate an
adjacentcy matrix, which was in turn used to calculate the gap statistic to
determine the optimal *k*-clusters.

```{r Sample_Clustering_chart}
annotation_info %>%
  mutate(cluster = as_factor(cluster)) %>%
  group_by(disease_class,
           cluster) %>%
  summarise(n = n()) %>%
  pivot_wider(names_from = cluster,
              values_from = n) %>%
  DT::datatable()

annotation_info %>%
  mutate(cluster = as_factor(cluster)) %>%
  select(disease_class, cluster) %>%
  group_by(disease_class) %>%
  mutate(total_disease = n()) %>%
  ungroup() %>%
  group_by(disease_class, cluster) %>%
  mutate(total_cluster_disease = n(),
         freq = total_cluster_disease/total_disease,
         cluster = as_factor(cluster)) %>%
  distinct() %>%
  ggplot(aes(
    x = disease_class,
    y = freq,
    group = cluster,
    fill = cluster
  )) +
  geom_col() +
  labs(y = "Proportion of disease class in cluster") +
  scale_fill_manual(values = group_pal$cluster) +
  theme_pubr()
```

\newpage

# Clustering and variation of samples in reduced dimensional space {.tabset .tabset-fade .tabset-pills}

## PCA {.tabset .tabset-fade .tabset-pills}
```{r}
loadd(pca_results)
```

\newpage

### PCA by disease classification
```{r PCA_by_disease_classification, fig.width=12, fig.height=6}
p1 <-
  ggplot(
    data = pca_results,
    aes(
      x = PC1,
      y = PC2,
      fill = disease_class,
      line = 1
    ),
    shape = 1
  ) +
    geom_point(
      shape = 21,
      colour = "black",
      size = 2.5,
      stroke = 0.5,
      alpha = 0.6
    ) +
    scale_fill_brewer(palette = "Set1") +
    theme_pubr() +
    theme(legend.position = "none")

p2 <-
  ggplot(
    data = pca_results,
    aes(
      x = PC1,
      y = PC2,
      fill = disease_class,
      line = 1
      ), shape = 1
    ) +
  geom_point(
    shape = 21,
    colour = "black",
    size = 2.5,
    stroke = 0.5,
    alpha = 0.6
    ) +
  scale_fill_brewer(palette = "Set1") +
  scale_color_brewer(palette = "Set1") +
  theme_pubr() +
  geom_mark_ellipse(aes(fill = disease_class,
                        color = disease_class),
                    alpha = 0.05
                    ) +
  theme(legend.position = "bottom")

legend <- get_legend(p2)

plot_grid(
  plot_grid(
    p1 + theme(legend.position = "none"),
    p2 + theme(legend.position = "none")
    ),
  legend,
  nrow = 2,
  rel_heights = c(1, .2)
)
```

\newpage

### PCA by plate
```{r PCA_by_plate, fig.width=12, fig.height=7}
p1 <- ggplot(
  data = pca_results,
  mapping = aes(
    x = PC1,
    y = PC2,
    fill = run_id
    )
  ) +
  geom_point(
    shape = 21,
    colour = "black",
    size = 2.5,
    stroke = 0.5,
    alpha = 0.6
    ) +
  labs(color = "run_id") +
  scale_color_paletteer_d("ggsci::default_igv") +
  scale_fill_paletteer_d("ggsci::default_igv")

p2 <- ggplot(
  data = pca_results,
  mapping = aes(
    x = PC1,
    y = PC2,
    fill = run_id
    )
  ) +
  geom_point(
    shape = 21,
    colour = "black",
    size = 2.5,
    stroke = 0.5,
    alpha = 0.6
    ) +
  labs(color = "run_id") +
  geom_mark_ellipse(aes(
    fill = run_id,
    color = run_id
    ),
    alpha = 0.05
    ) +
  scale_color_paletteer_d("ggsci::default_igv") +
  scale_fill_paletteer_d("ggsci::default_igv") +
  guides(color = guide_legend(nrow = 4)) +
  theme(legend.position = "bottom")

legend <- get_legend(p2)

plot_grid(
  plot_grid(
    p1 + theme(legend.position = "none"),
    p2 + theme(legend.position = "none")
    ),
  legend,
  nrow = 2,
  rel_heights = c(1, .2)
)
```

\newpage

### PCA by ethnicity
```{r PCA_by_ethnicity, fig.width=12, fig.height=6}
p1 <-
  pca_results %>%
  select(
    PC1,
    PC2,
    sample_name,
    ethnicity
    ) %>%
  mutate(ethnicity = as_factor(ethnicity)) %>%
  ggplot(
    aes(
      x = PC1,
      y = PC2,
      fill = ethnicity,
      line = 1
    ),
    shape = 1
  ) +
    geom_point(
      shape = 21,
      colour = "black",
      size = 2.5,
      stroke = 0.5,
      alpha = 0.6
    ) +
    scale_fill_paletteer_d(palette = "ggthemes::calc") +
    theme_pubr() +
    theme(legend.position = "none")

p2 <-
  pca_results %>%
  select(PC1, PC2, sample_name, ethnicity) %>%
  mutate(ethnicity = as_factor(ethnicity)) %>%
  ggplot(
    aes(
      x = PC1,
      y = PC2,
      fill = ethnicity,
      line = 1
      ), shape = 1
    ) +
  geom_point(
    shape = 21,
    colour = "black",
    size = 2.5,
    stroke = 0.5,
    alpha = 0.6
    ) +
  scale_fill_paletteer_d(palette = "ggthemes::calc") +
  scale_color_paletteer_d(palette = "ggthemes::calc") +
  theme_pubr() +
  geom_mark_ellipse(aes(fill = ethnicity,
                        color = ethnicity),
                    alpha = 0.05
                    ) +
  theme(legend.position = "bottom")

legend <- get_legend(p2)

plot_grid(
  plot_grid(
    p1 + theme(legend.position = "none"),
    p2 + theme(legend.position = "none")
    ),
  legend,
  nrow = 2,
  rel_heights = c(1, .2)
)
```

\newpage

### PCA by K-means cluster
```{r PCA_by_K-means cluster, fig.width=7, fig.height=6}
pca_results %>%
  ggplot(
    aes(
      x = PC1,
      y = PC2,
      fill = cluster
      )
    ) +
  geom_point(
    shape = 21,
    colour = "black",
    size = 2.5,
    stroke = 0.5
    ) +
  scale_fill_manual(values = group_pal$cluster)
```

<!-- ### 3D PCA colored by K-means cluster -->
<!-- ```{r 3D_PCA_colored_by_K-means cluster} -->
<!-- pca_results %>% -->
<!--   plot_ly( -->
<!--     x = ~PC1, -->
<!--     y = ~PC2, -->
<!--     z = ~PC3, -->
<!--     colors = group_pal$cluster -->
<!--   ) %>% -->
<!--   add_markers( -->
<!--     text = str_glue("Sample: {pca_results$sample_name}<br>Classification: {pca_results$disease_class}<br>Ethnicity {pca_results$ethnicity}<br>Cluster: {pca_results$cluster}<br>Sex: {pca_results$sex}<br>Plate: {pca_results$run_id}"), -->
<!--     color = ~cluster, -->
<!--     size = 2.5, -->
<!--     alpha = 0.9, -->
<!--     hovertemplate = "%{text}", -->
<!--     marker = list( -->
<!--       size = 3, -->
<!--       line = list( -->
<!--         color = 'rgba(0, 0, 0, .8)', -->
<!--         width = 1.5 -->
<!--       ) -->
<!--     ) -->
<!--   ) -->
<!-- ``` -->

\newpage

## UMAP {.tabset .tabset-fade .tabset-pills}
```{r}
loadd(umap_results)
```


### UMAP by disease classification
```{r UMAP_by_disease_classification, fig.width=12, fig.height=7}
p1 <-
  ggplot(
    data = umap_results,
    aes(
      x = umap_1,
      y = umap_2,
      fill = disease_class,
      line = 1
    ),
    shape = 1
  ) +
    geom_point(
      shape = 21,
      colour = "black",
      size = 2.5,
      stroke = 0.5,
      alpha = 0.6
    ) +
    scale_fill_brewer(palette = "Set1") +
    theme_pubr() +
    theme(legend.position = "none")

p2 <-
  ggplot(
    data = umap_results,
    aes(
      x = umap_1,
      y = umap_2,
      fill = disease_class,
      line = 1
    ), shape = 1
  ) +
    geom_point(
      shape = 21,
      colour = "black",
      size = 2.5,
      stroke = 0.5,
      alpha = 0.6
    ) +
    scale_fill_brewer(palette = "Set1") +
    scale_color_brewer(palette = "Set1") +
    theme_pubr() +
    geom_mark_ellipse(aes(fill = disease_class,
                          color = disease_class),
                      alpha = 0.05
    ) +
  guides(color = guide_legend(nrow = 4)) +
  theme(legend.position = "bottom")

legend <- get_legend(p2)

plot_grid(
  plot_grid(
    p1 + theme(legend.position = "none"),
    p2 + theme(legend.position = "none")
    ),
  legend,
  nrow = 2,
  rel_heights = c(1, .2)
)
```

\newpage

### UMAP by plate
```{r UMAP_by_plate, fig.width=12, fig.height=7}
p1 <- ggplot(
  data = umap_results,
  mapping = aes(
    x = umap_1,
    y = umap_2,
    fill = run_id
  )
) +
  geom_point(
    shape = 21,
    colour = "black",
    size = 2.5,
    stroke = 0.5,
    alpha = 0.6
  ) +
  labs(color = "run_id") +
  scale_color_paletteer_d("ggsci::default_igv") +
  scale_fill_paletteer_d("ggsci::default_igv")

p2 <- ggplot(
  data = umap_results,
  mapping = aes(
    x = umap_1,
    y = umap_2,
    fill = run_id
    )
  ) +
  geom_point(
    shape = 21,
    colour = "black",
    size = 2.5,
    stroke = 0.5,
    alpha = 0.6
    ) +
  labs(color = "run_id") +
  geom_mark_ellipse(aes(
    fill = run_id,
    color = run_id
    ),
    alpha = 0.05
    ) +
  scale_color_paletteer_d("ggsci::default_igv") +
  scale_fill_paletteer_d("ggsci::default_igv") +
  guides(color = guide_legend(nrow = 4)) +
  theme(legend.position = "bottom")

legend <- get_legend(p2)

plot_grid(
  plot_grid(
    p1 + theme(legend.position = "none"),
    p2 + theme(legend.position = "none")
    ),
  legend,
  nrow = 2,
  rel_heights = c(1, .2)
)
```

\newpage

### UMAP by ethnicity
```{r UMAP_by_ethnicity, fig.width=12, fig.height=6}
p1 <-
  umap_results %>%
  select(umap_1, umap_2, sample_name, ethnicity) %>%
  mutate(ethnicity = as_factor(ethnicity)) %>%
  ggplot(
    aes(
      x = umap_1,
      y = umap_2,
      fill = ethnicity,
      line = 1
    ),
    shape = 1
  ) +
    geom_point(
      shape = 21,
      colour = "black",
      size = 2.5,
      stroke = 0.5,
      alpha = 0.6
    ) +
    scale_fill_paletteer_d(palette = "ggthemes::calc") +
    theme_pubr() +
    theme(legend.position = "none")

p2 <-
  umap_results %>%
  select(umap_1, umap_2, sample_name, ethnicity) %>%
  mutate(ethnicity = as_factor(ethnicity)) %>%
  ggplot(
    aes(
      x = umap_1,
      y = umap_2,
      fill = ethnicity,
      color = ethnicity,
      line = 1
      ), shape = 1
    ) +
  geom_point(
    shape = 21,
    colour = "black",
    size = 2.5,
    stroke = 0.5,
    alpha = 0.6
    ) +
  scale_fill_paletteer_d(palette = "ggthemes::calc") +
  scale_color_paletteer_d(palette = "ggthemes::calc") +
  theme_pubr() +
  geom_mark_ellipse(
    alpha = 0.05
    ) +
  theme(legend.position = "bottom")

legend <- get_legend(p2)

plot_grid(
  plot_grid(
    p1 + theme(legend.position = "none"),
    p2 + theme(legend.position = "none")
    ),
  legend,
  nrow = 2,
  rel_heights = c(1, .2)
)
```

\newpage

### UMAP by K-means cluster
```{r UMAP_by_K-means cluster, fig.height=6, fig.width=7}
umap_results %>%
  ggplot(
    aes(
      x = umap_1,
      y = umap_2,
      fill = cluster
      )
    ) +
  geom_point(
    shape = 21,
    colour = "black",
    size = 2.5,
    stroke = 0.5
    ) +
  scale_fill_manual(values = group_pal$cluster)
```

<!-- ### UMAP in 3D by K-means cluster -->
<!-- ```{r UMAP_in_3D_by_K-means cluster} -->
<!-- umap_results %>% -->
<!--   plot_ly( -->
<!--     x = ~umap_1, -->
<!--     y = ~umap_2, -->
<!--     z = ~umap_3, -->
<!--     colors = group_pal$cluster -->
<!--   ) %>% -->
<!--   add_markers( -->
<!--     text = str_glue("Sample: {umap_results$sample_name}<br>Classification: {umap_results$disease_class}<br>Ethnicity {umap_results$ethnicity}<br>Cluster: {umap_results$cluster}<br>Sex: {umap_results$sex}<br>Plate: {umap_results$run_id}"), -->
<!--     color = ~cluster, -->
<!--     size = 2.5, -->
<!--     alpha = 0.9, -->
<!--     hovertemplate = "%{text}", -->
<!--     marker = list( -->
<!--       size = 3, -->
<!--       line = list( -->
<!--         color = 'rgba(0, 0, 0, .8)', -->
<!--         width = 1.5 -->
<!--       ) -->
<!--     ) -->
<!--   ) -->
<!-- ``` -->

\newpage

# Module scores {.tabset .tabset-fade .tabset-pills}

## SLE Interferon module scores {.tabset .tabset-fade .tabset-pills}
```{r SLE_Interferon_module_scores}
loadd(module_scores_with_viral, ifn_modules)
```

### Sorted by disease classification
```{r SLE_Interferon_module_scores_disease_sort, fig.width=3, fig.height=6}
range_bound = 4
zscore_range <- c(-range_bound:range_bound)
module_scores_with_viral %>%
  select(sample_name, one_of(ifn_modules)) %>%
  arrange(match(sample_name, sample_disease_order)) %>%
  column_to_rownames("sample_name") %>%
  pheatmap(
    scale="column",
    fontsize = 9,
    show_rownames = FALSE,
    annotation_colors = group_pal,
    annotation_row = annotation_info,
    breaks = zscore_range,
    cluster_rows = FALSE,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    angle = 315,
    gaps_row = sample_disease_order_count,
    border_color = NA)
```

\newpage

### Sorted by cluster
```{r SLE_Interferon_module_scores_cluster_sort, fig.width=3, fig.height=6}
range_bound = 4
zscore_range <- c(-range_bound:range_bound)
module_scores_with_viral %>%
  select(sample_name, one_of(ifn_modules)) %>%
  arrange(match(sample_name, sample_cluster_order)) %>%
  column_to_rownames("sample_name") %>%
  pheatmap(
    scale="column",
    fontsize = 9,
    show_rownames = FALSE,
    annotation_colors = group_pal,
    annotation_row = annotation_info,
    breaks = zscore_range,
    cluster_rows = FALSE,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    angle = 315,
    gaps_row = sample_cluster_order_count,
    border_color = NA)
```

\newpage

### Sorted by hierarchical clustering
```{r SLE_Interferon_module_scores_auto_sort, fig.width=4, fig.height=6}
range_bound = 4
zscore_range <- c(-range_bound:range_bound)
module_scores_with_viral %>%
  select(sample_name, one_of(ifn_modules)) %>%
  column_to_rownames("sample_name") %>%
  pheatmap(
    scale="column",
    fontsize = 9,
    show_rownames = FALSE,
    annotation_colors = group_pal,
    annotation_row = annotation_info,
    breaks = zscore_range,
    cluster_rows = TRUE,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    angle = 315,
    border_color = NA)
```

\newpage

## SLE Inflammatory module scores {.tabset .tabset-fade .tabset-pills}
```{r SLE_Inflammatory_module_scores, fig.height=9, fig.width=6}
loadd(inflame_modules)
```

### Sorted by disease classification
```{r SLE_Inflammatory_module_scores_disease_sort, fig.width=4, fig.height=6}
range_bound = 4
zscore_range <- c(-range_bound:range_bound)
module_scores_with_viral %>%
  select(sample_name, one_of(inflame_modules)) %>%
  arrange(match(sample_name, sample_disease_order)) %>%
  column_to_rownames("sample_name") %>%
  pheatmap(
    scale="column",
    fontsize = 9,
    show_rownames = FALSE,
    annotation_colors = group_pal,
    annotation_row = annotation_info,
    breaks = zscore_range,
    cluster_rows = FALSE,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    angle = 315,
    gaps_row = sample_disease_order_count,
    border_color = NA)
```

\newpage

### Sorted by cluster
```{r SLE_Inflammatory_module_scores_cluster_sort, fig.width=4, fig.height=6}
range_bound = 4
zscore_range <- c(-range_bound:range_bound)
module_scores_with_viral %>%
  select(sample_name, one_of(inflame_modules)) %>%
  arrange(match(sample_name, sample_cluster_order)) %>%
  column_to_rownames("sample_name") %>%
  pheatmap(
    scale="column",
    fontsize = 9,
    show_rownames = FALSE,
    annotation_colors = group_pal,
    annotation_row = annotation_info,
    breaks = zscore_range,
    cluster_rows = FALSE,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    angle = 315,
    gaps_row = sample_cluster_order_count,
    border_color = NA)
```

\newpage

### Sorted by hierarchical clustering
```{r SLE_Inflammatory_module_scores_auto_sort, fig.width=4.5, fig.height=6}
range_bound = 4
zscore_range <- c(-range_bound:range_bound)
module_scores_with_viral %>%
  select(sample_name, one_of(inflame_modules)) %>%
  column_to_rownames("sample_name") %>%
  pheatmap(
    scale="column",
    fontsize = 9,
    show_rownames = FALSE,
    annotation_colors = group_pal,
    annotation_row = annotation_info,
    breaks = zscore_range,
    cluster_rows = TRUE,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    angle = 315,
    border_color = NA)
```

## Low-density granulocyte module scores {.tabset .tabset-fade .tabset-pills}
```{r Low-density granulocyte module scores}
range_bound = 3
zscore_range <- c(-range_bound:range_bound)
```

### Sorted by disease classification
```{r ldg_module_disease_sort, fig.width=3.25, fig.height=6}
module_scores_with_viral %>%
    select(sample_name,
         one_of(names(ldg_modules))) %>%
  arrange(match(sample_name, sample_disease_order)) %>%
  column_to_rownames("sample_name") %>%
  pheatmap(
    scale="column",
    fontsize = 9,
    show_rownames = FALSE,
    annotation_colors = group_pal,
    annotation_row = annotation_info,
    breaks = zscore_range,
    cluster_rows = FALSE,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    angle = 315,
    gaps_row = sample_disease_order_count,
    border_color = NA)
```

### Sorted by cluster
```{r ldg_module_cluster_sort, fig.width=3.25, fig.height=6}
module_scores_with_viral %>%
    select(sample_name,
         one_of(names(ldg_modules))) %>%
  arrange(match(sample_name, sample_cluster_order)) %>%
  column_to_rownames("sample_name") %>%
  pheatmap(
    scale="column",
    fontsize = 9,
    show_rownames = FALSE,
    annotation_colors = group_pal,
    annotation_row = annotation_info,
    breaks = zscore_range,
    cluster_rows = FALSE,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    angle = 315,
    gaps_row = sample_cluster_order_count,
    border_color = NA)
```

### Sorted by hierarchical clustering
```{r ldg_module_auto_sort, fig.width=4, fig.height=6}
module_scores_with_viral %>%
    select(sample_name,
         one_of(names(ldg_modules))) %>%
  column_to_rownames("sample_name") %>%
  pheatmap(
    scale="column",
    fontsize = 9,
    show_rownames = FALSE,
    annotation_colors = group_pal,
    annotation_row = annotation_info,
    breaks = zscore_range,
    cluster_rows = TRUE,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    angle = 315,
    border_color = NA)
```

## SLE Modules with an annotated associated pathway {.tabset .tabset-fade .tabset-pills}
```{r}
loadd(annotated_modules, annotated_mod_list)
```


```{r SLE_Modules_with_an_annotated_associated_pathway, fig.height=9, fig.width=11}
range_bound = 4
zscore_range <- c(-range_bound:range_bound)

module_order <- c(
  "M1.1",
  
  "M2.3",
  "M3.1",
  "M6.18",
  
  "M1.2",
  "M3.4",
  "M5.12",
  
  "M3.2",
  "M4.2",
  "M4.6",
  "M4.13",
  "M5.1",
  "M5.7",
  "M7.1",
  
  "M3.6",
  "M8.46",
  "M4.1",
  "M4.15",
  "M4.10",
  "M4.11",
  
  "M4.14",
  "M5.15",
  "ldg_1.1",
  "ldg_2.1",
  "M8.83",
  
  "M6.6",
  "M2.2",
  "M3.3",
  "M3.5",
  "M4.7",
  "M6.11",
  "M6.16",
  "M9.42",
  "M6.13",
  "M4.3",
  "M4.5",
  "M5.9",
  "M5.6",
  "M5.10",
  "M6.2",
  "M6.12"
)

module_gaps <- c(1,4,7,14,20,25)
```

### Sorted by disease classification
```{r annotated_module_disease_sort, fig.width=12, fig.height=9}
module_scores_with_viral %>%
  arrange(disease_class) %>%
  select(
    sample_name,
    one_of(module_order)
  ) %>%
  pivot_longer(
    cols = one_of(module_order),
    names_to = "module",
    values_to = "score"
    ) %>%
  mutate(
    module =
      recode(
        module,
        !!!annotated_mod_list
        )
    ) %>%
  pivot_wider(
    names_from = "module",
    values_from = "score"
    ) %>%
  column_to_rownames("sample_name") %>%
  t() %>%
  pheatmap(
    scale="row",
    fontsize = 9,
    show_rownames = TRUE,
    show_colnames = FALSE,
    annotation_colors = group_pal,
    annotation_row = column_to_rownames(mutate(annotated_modules, module = recode(module, !!!annotated_mod_list)), var = "module"),
    annotation_col = arrange(annotation_info[,"disease_class",drop=FALSE], disease_class),
    breaks = zscore_range,
    cluster_rows = FALSE,
    cluster_cols = FALSE,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    angle = 315,
    gaps_col = sample_disease_order_count,
    gaps_row = module_gaps,
    border_color = NA)
```

### Sorted by cluster
```{r annotated_modulecluster_sort, fig.width=12, fig.height=9}
module_scores_with_viral %>%
  arrange(cluster) %>%
  select(
    sample_name,
    one_of(module_order)
  ) %>%
  pivot_longer(
    cols = one_of(module_order),
    names_to = "module",
    values_to = "score"
    ) %>%
  mutate(
    module =
      recode(
        module,
        !!!annotated_mod_list
        )
    ) %>%
  pivot_wider(
    names_from = "module",
    values_from = "score"
    ) %>%
  column_to_rownames("sample_name") %>%
  t() %>%
  pheatmap(
    scale="row",
    fontsize = 9,
    show_rownames = TRUE,
    show_colnames = FALSE,
    annotation_colors = group_pal,
    annotation_row = column_to_rownames(mutate(annotated_modules, module = recode(module, !!!annotated_mod_list)), var = "module"),
    annotation_col = arrange(annotation_info[,"cluster",drop=FALSE], cluster),
    breaks = zscore_range,
    cluster_rows = FALSE,
    cluster_cols = FALSE,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    angle = 315,
    gaps_col = sample_cluster_order_count,
    gaps_row = module_gaps,
    border_color = NA)
```

### Sorted by hierarchical clustering
```{r annotated_module_auto_sort, fig.width=12, fig.height=9}
module_scores_with_viral %>%
  select(sample_name,
         one_of(module_order)) %>%
  column_to_rownames("sample_name") %>%
  t() %>%
  pheatmap(
    scale="row",
    fontsize = 9,
    show_rownames = FALSE,
    show_colnames = TRUE,
    annotation_colors = group_pal,
    annotation_row = column_to_rownames(annotated_modules, var = "module"),
    annotation_col = annotation_info[,c("cluster", "disease_class"),drop=FALSE],
    breaks = zscore_range,
    cluster_rows = FALSE,
    cluster_cols = TRUE,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    angle = 315,
    gaps_row = module_gaps,
    border_color = NA)
```

\newpage

## All SLE modules {.tabset .tabset-fade .tabset-pills}
```{r All_SLE_modules, fig.height=9, fig.width=11}
loadd(module_annotation)
range_bound = 3
zscore_range <- c(-range_bound:range_bound)
```

### Sorted by disease classification
```{r all_module_disease_sort, fig.width=12, fig.height=9}
module_scores_with_viral %>%
  select(
    sample_name,
    matches("^M[[:digit:]]+")
    ) %>%
  arrange(
    match(
      sample_name,
      sample_disease_order
      )
    ) %>%
  column_to_rownames("sample_name") %>%
  pheatmap(
    scale = 'column',
    fontsize = 9,
    annotation_row = annotation_info,
    annotation_col = column_to_rownames(module_annotation, var = "module"),
    annotation_colors = group_pal,
    show_rownames = FALSE,
    show_colnames = FALSE,
    angle_col = 315,
    breaks = zscore_range,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    gaps_row = sample_disease_order_count,
    border_color = NA,
    cluster_rows = FALSE
  )
```

### Sorted by cluster
```{r all_module_cluster_sort, fig.width=12, fig.height=9}
module_scores_with_viral %>%
  select(
    sample_name,
    matches("^M[[:digit:]]+")
    ) %>%
  arrange(
    match(
      sample_name,
      sample_cluster_order
      )
    ) %>%
  column_to_rownames("sample_name") %>%
  pheatmap(
    scale = 'column',
    fontsize = 9,
    annotation_row = annotation_info,
    annotation_col = column_to_rownames(module_annotation, var = "module"),
    annotation_colors = group_pal ,
    show_rownames = FALSE,
    show_colnames = FALSE,
    angle_col = 315,
    breaks = zscore_range,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    border_color = NA,
    gaps_row = sample_cluster_order_count,
    cluster_rows = FALSE
  )
```

### Sorted by hierarchical clustering
```{r all_module_auto_sort, fig.width=12, fig.height=9}
module_scores_with_viral %>%
  select(
    sample_name,
    matches("^M[[:digit:]]+")
    ) %>%
  column_to_rownames("sample_name") %>%
  pheatmap(
    scale = 'column',
    fontsize = 9,
    annotation_row = annotation_info,
    annotation_col = column_to_rownames(module_annotation, var = "module"),
    annotation_colors = group_pal,
    show_rownames = FALSE,
    show_colnames = FALSE,
    angle_col = 315,
    breaks = zscore_range,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    border_color = NA
  )
```

\newpage

## Expression of the annotated Banchereau modules {.tabset .tabset-fade .tabset-pills}
```{r}
loadd(
  module_scores_with_viral,
  annotated_module_scores,
  annotated_module_scores_pivot,
  annotated_module_stats_by_cluster,
  annotated_module_stats_by_disease
  )

number_of_modules <-
  ncol(annotated_module_scores) - 1

number_of_pages <-
  ceiling(number_of_modules/9)
```

### By disease classification
```{r Banchereau_modules_by_disease, echo=FALSE, fig.height=8, fig.width=12, warning=FALSE}
annotated_module_disease_class_graphs <-
  annotated_module_scores_pivot %>%
  select(-cluster) %>%
  mutate(disease_class = as_factor(disease_class)) %>%
  ggviolin(
    x = "disease_class",
    y = "score",
    fill = "disease_class",
    draw_quantiles = c(0.25, 0.5, 0.75),
    add = "jitter",
    trim = TRUE,
    add.params = list(size = 1, alpha = 0.25)
    ) +
  scale_fill_paletteer_d("ggsci::uniform_startrek") +
  stat_pvalue_manual(
    data = annotated_module_stats_by_disease,
    label = "p",
    hide.ns = TRUE,
    bracket.size = 0.1,
    tip.length = 0.01,
    size = 4
  ) +
  theme_pubr() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 9),
        axis.text.y = element_text(size = 9))
  
for(i in seq(number_of_pages)){
  print(
    annotated_module_disease_class_graphs +
      facet_wrap_paginate(
        facets = vars(module),
        scales = "free_y",
        nrow = 2,
        ncol = 3,
        page = i)
  )
}
```

### By cluster
```{r Banchereau_modules_by_cluster, echo=FALSE, fig.height=8, fig.width=12, warning=FALSE}
number_of_modules <-
  ncol(annotated_module_scores) - 1

number_of_pages <-
  ceiling(number_of_modules/9)
  
annotated_module_cluster_graphs <-
  annotated_module_scores_pivot %>%
  select(-disease_class) %>%
  mutate(cluster = as_factor(cluster)) %>%
  ggviolin(
    x = "cluster",
    y = "score",
    fill = "cluster",
    draw_quantiles = c(0.25, 0.5, 0.75),
    add = "jitter",
    trim = TRUE,
    add.params = list(size = 1, alpha = 0.5)
    ) +
  scale_fill_paletteer_d("ggsci::uniform_startrek") +
  stat_pvalue_manual(
    data = annotated_module_stats_by_cluster,
    label = "p",
    hide.ns = TRUE,
    bracket.size = 0.1,
    tip.length = 0.01,
    size = 4
  ) +
  theme_pubr() +
  theme(
    axis.text.x =
      element_text(
        angle = 45,
        hjust = 1,
        vjust = 1,
        size = 9
        ),
    axis.text.y =
      element_text(size = 9)
    )
  

for(i in seq(number_of_pages)){
  print(
    annotated_module_cluster_graphs +
      facet_wrap_paginate(
        facets = vars(module),
        scales = "free_y",
        nrow = 2,
        ncol = 3,
        page = i)
  )
}
```

\newpage

# WGCNA
```{r include=FALSE}
loadd(wgcna_modules)
```

## Expression similarity dendrogram
```{r WGCNA_Expression_similarity_dendrogram, echo=FALSE, fig.height=6, fig.width=10}
plotDendroAndColors(dendro = wgcna_modules$dendrograms[[1]],
                    colors = wgcna_modules$colors[wgcna_modules$blockGenes[[1]]],
                    groupLabels = "Module colors",
                    main = "Gene dendrogram and module colors in block 1",
                    dendroLabels = FALSE,
                    hang = 0.03,
                    addGuide = TRUE,
                    guideHang = 0.05)
```

## Expression of identified modules {.tabset .tabset-fade .tabset-pills}
```{r include=FALSE}
loadd(
  module_scores_with_viral_by_cluster,
  module_scores_with_viral_by_cluster_stats,
  module_scores_with_viral_by_disease, 
  module_scores_with_viral_by_disease_stats
)

mods <- module_scores_with_viral_by_disease %>% pull(module) %>% unique()
module_bins <- split(mods, ceiling(seq_along(mods)/9))
```

### By disease classification 
```{r wgcna_by_disease, echo=FALSE, fig.height=8, fig.width=12}

for(i in seq(module_bins)){

  g <-
    module_scores_with_viral_by_disease %>%
    filter(module %in% module_bins[[i]]) %>%
    ggviolin(
      x = "disease_class",
      y = "score",
      fill = "disease_class",
      draw_quantiles = c(0.25, 0.5, 0.75),
      add = "jitter",
      trim = TRUE,
      add.params = list(size = 1, alpha = 0.25)
      ) +
    scale_fill_paletteer_d("ggsci::uniform_startrek") +
    stat_pvalue_manual(
      data = filter(module_scores_with_viral_by_disease_stats, module %in% module_bins[[i]]),
      label = "p",
      hide.ns = TRUE,
      bracket.size = 0.1,
      tip.length = 0.01,
      size = 4
    ) +
    theme_pubr() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 9),
          axis.text.y = element_text(size = 9),
          plot.caption = element_markdown()) +
    labs(caption = "Mann-Whitney, Benjamini–Hochberg adjusted value.\n *<i>p</i> <0.05, **<i>p</i> <0.01, ***<i>p</i> <0.001, ****<i>p</i> <0.0001") +
    facet_wrap(vars(module), scales = "free_y", ncol = 3, nrow = 3)
  
  print(g)
}
```

\newpage

### By cluster
```{r wgcna_modules_by_cluster, echo=FALSE, fig.height=8, fig.width=12}
for (i in seq(module_bins)){
  g <-
    module_scores_with_viral_by_cluster %>%
    filter(module %in% module_bins[[i]]) %>%
    ggviolin(
      x = "cluster",
      y = "score",
      fill = "cluster",
      draw_quantiles = c(0.25, 0.5, 0.75),
      add = "jitter",
      trim = TRUE,
      add.params = list(size = 1, alpha = 0.25)
      ) +
    scale_fill_paletteer_d("ggsci::uniform_startrek") +
    stat_pvalue_manual(
      data = filter(module_scores_with_viral_by_cluster_stats, module %in% module_bins[[i]]),
      label = "p",
      hide.ns = TRUE,
      bracket.size = 0.1,
      tip.length = 0.01,
      size = 4
    ) +
    theme_pubr() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, size = 9),
          axis.text.y = element_text(size = 9),
          plot.caption = element_markdown()) +
    labs(caption = "Mann-Whitney, Benjamini–Hochberg adjusted value.\n *<i>p</i> <0.05, **<i>p</i> <0.01, ***<i>p</i> <0.001, ****<i>p</i> <0.0001") +
    facet_wrap(vars(module), scales = "free_y", ncol = 3, nrow = 3)
  
  print(g)
}
```

\newpage

## WGCNA eigenvalues {.tabset .tabset-fade .tabset-pills}
```{r wgcna_eigenvalues, fig.height=9, fig.width=11}
range_bound = 4
zscore_range <- c(-range_bound:range_bound)
```

### Sorted by disease classification
```{r WGCNA_eigenvalues_disease_sort, fig.width=12, fig.height=9}
module_scores_with_viral %>%
  select(
    sample_name,
    matches("^ME")
    ) %>%
  arrange(
    match(
      sample_name,
      sample_disease_order
      )
    ) %>%
  column_to_rownames("sample_name") %>%
  pheatmap(
    scale = 'column',
    fontsize = 9,
    annotation_row = annotation_info,
    annotation_colors = group_pal,
    show_rownames = FALSE,
    show_colnames = TRUE,
    angle_col = 315,
    breaks = zscore_range,
    cluster_rows = FALSE,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    gaps_row = sample_disease_order_count,
    border_color = NA,
    )
```

### Sorted by cluster
```{r WGCNA_eigenvalues_cluster_sort, fig.width=12, fig.height=9}
module_scores_with_viral %>%
  select(
    sample_name,
    matches("^ME")
    ) %>%
  arrange(
    match(
      sample_name,
      sample_cluster_order
      )
    ) %>%
  column_to_rownames("sample_name") %>%
  pheatmap(
    scale = 'column',
    fontsize = 9,
    annotation_row = annotation_info,
    annotation_colors = group_pal,
    show_rownames = FALSE,
    show_colnames = TRUE,
    angle_col = 315,
    breaks = zscore_range,
    cluster_rows = FALSE,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    border_color = NA,
    gaps_row = sample_cluster_order_count
    )
```

### Sorted by hierarchical clustering
```{r WGCNA_eigenvalues_auto_sort, fig.width=12, fig.height=9}
module_scores_with_viral %>%
  select(
    sample_name,
    matches("^ME")
    ) %>%
  column_to_rownames("sample_name") %>%
  pheatmap(
    scale = 'column',
    fontsize = 9,
    annotation_row = annotation_info,
    annotation_colors = group_pal,
    show_rownames = FALSE,
    show_colnames = TRUE,
    angle_col = 315,
    breaks = zscore_range,
    cluster_rows = TRUE,
    color = viridis(n = length(zscore_range)-1, option = "D"),
    border_color = NA
    )
```

\newpage

## Gene ontology GSEA of WGCNA modules
```{r wgcna_gsea, fig.height=11, fig.width=12}
loadd(MEplotting)

for(i in 1:ceiling(length(unique(MEplotting$module))/6)){
    
      plots <-
        ggplot(data = MEplotting,
               mapping = aes(
                 y = GeneRatio,
                 x = order,
                 color = p.adjust)
               ) +
          geom_point(stat = "identity",
                     size = 2) +
          scale_x_continuous(breaks = MEplotting$order,
                           labels = str_wrap(MEplotting$ID, width = 40),
                           expand = c(0.1,0.1)) +
          scale_color_gradient(low = "blue", high = "red") +
          labs(color = "adjusted\np value") +
          facet_wrap_paginate(~ module,
                              ncol = 2,
                              nrow = 3,
                              scales = "free",
                              page = i) +
          theme(axis.text.y = element_text(size = 9),
                axis.text.x = element_text(size = 9),
                panel.background = element_rect(fill = "white", linetype = "solid"),
                panel.border = element_rect(colour = "black", fill=NA, size=1),
                panel.grid = element_line(color = "grey90"),
                axis.title.y = element_blank()) +
          coord_flip()
      print(plots)
}
```

\newpage

## Use of WGCNA modules in classifying clusters.

The module eigengene scores were used to train a random forest model with repeated cross validation to predict cluster identity.

The model was trained with 75% of the dataset and tested on 25%.

Note: Subjects with LP were excluded due to the small population size.

```{r wgcna_cluster_confusion}
loadd(wgcna_cluster_rf_cv, wgcna_cluster_test)

caret::confusionMatrix(
  data = predict(wgcna_cluster_rf_cv, wgcna_cluster_test),
  reference = as_factor(wgcna_cluster_test$cluster)
)
```

The relative importance of each eigengene in classification:

```{r wgcna_cluster_importance}
loadd(wgcna_cluster_rf_cv_varImp)

wgcna_cluster_rf_cv_varImp
```

\newpage

## Use of WGCNA modules in labeling disease class.

The module eigengene scores were used to train a random forest model with repeated cross validation to predict cluster identity.

The model was trained with 75% of the dataset and tested on 25%.

```{r wgcna_disease_confusion}
loadd(wgcna_disease_class_rf_cv, wgcna_disease_class_test)

caret::confusionMatrix(
  data = predict(wgcna_disease_class_rf_cv, wgcna_disease_class_test),
  reference = as_factor(wgcna_disease_class_test$disease_class)
)
```

The relative importance of each eigengene in classification:

```{r wgcna_disease_importance}
loadd(wgcna_disease_class_rf_cv_varImp)

wgcna_disease_class_rf_cv_varImp
```

\newpage

## Use of module modules in classifying clusters.

The module eigengene scores were used to train a random forest model with repeated cross validation to predict cluster identity.

The model was trained with 75% of the dataset and tested on 25%.

```{r Banchereau_cluster_confusion}
loadd(module_cluster_rf_cv, module_cluster_test)

caret::confusionMatrix(
  data = predict(module_cluster_rf_cv, module_cluster_test),
  reference = as_factor(module_cluster_test$cluster)
)
```

The relative importance of each eigengene in classification:

```{r Banchereau_cluster_importance}
loadd(module_cluster_rf_cv_varImp)

module_cluster_rf_cv_varImp
```

\newpage

## Use of module modules in labeling disease class.

The module eigengene scores were used to train a random forest model with repeated cross validation to predict cluster identity.

The model was trained with 75% of the dataset and tested on 25%.

```{r Banchereau_disease_confusion}
loadd(module_disease_class_rf_cv, module_disease_class_test)

caret::confusionMatrix(
  data = predict(module_disease_class_rf_cv, module_disease_class_test),
  reference = as_factor(module_disease_class_test$disease_class)
)
```

The relative importance of each eigengene in classification:

```{r Banchereau_disease_importance}
loadd(module_disease_class_rf_cv_varImp)

module_disease_class_rf_cv_varImp
```

```{r}
sessioninfo::session_info()
```
